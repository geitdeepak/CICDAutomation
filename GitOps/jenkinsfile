@Library('shared') _
pipeline {
    agent {label 'built-in'}
    
    parameters {
        string(name: 'FRONTEND_DOCKER_TAG', defaultValue: '', description: 'Frontend Docker tag of the image built by the CI job')
    }

    stages {
        stage("Workspace cleanup"){
            steps{
                script{
                    cleanWs()
                }
            }
        }
        
        stage('Git: Code Checkout') {
            steps {
                script{
                    code_checkout("https://github.com/dsumanta/CICDAutomation.git","master","github")
                }
            }
        }
        
        stage('Verify: Docker Image Tags') {
            steps {
                script{
                    echo "FRONTEND_DOCKER_TAG: ${params.FRONTEND_DOCKER_TAG}"
                }
            }
        }
        
        
        stage("Update: Kubernetes manifests"){
            steps{
                script{
                    dir('kubernatee'){
                        def tag = "${params.FRONTEND_DOCKER_TAG}"
                        sh """
                            sed -i 's|image: dsumanta/ai-frontend:.*|image: dsumanta/ai-frontend:${tag}|g' frontend-deployment.yml
                        """
                    }
                    
                }
            }
        }
        
        stage("Git: Code update and push to GitHub"){
            steps{
                script{
                    withCredentials([gitUsernamePassword(credentialsId: 'github', gitToolName: 'Default')]) {
                        sh '''
                        echo "Checking repository status: "
                        git status
                    
                        echo "Adding changes to git: "
                        git add .
                        
                        echo "Commiting changes: "
                        git commit -m "Updated environment variables"
                        
                        echo "Pushing changes to github: "
                        git push https://github.com/dsumanta/CICDAutomation.git master
                    '''
                    }
                }
            }
        }
    }
  post {
    success {
        script {
            emailext(
                attachLog: true,
                from: 'geit.deepak@gmail.com',
                subject: "‚úÖ AI Frontend Application has been updated and deployed",
                body: """
                    <html>
                    <body style="font-family: Arial, sans-serif;">
                        <h2 style="color: #333;">üöÄ Deployment Successful</h2>
                        
                        <div style="background-color: #FFA07A; padding: 15px; margin-bottom: 10px; border-radius: 5px;">
                            <h3 style="color: white; margin: 0;">Build Information</h3>
                            <p style="color: white; margin: 5px 0;">
                                <strong>Job:</strong> ${JOB_NAME}<br>
                                <strong>Build Number:</strong> ${BUILD_NUMBER}<br>
                                <strong>Build URL:</strong> ${BUILD_URL}
                            </p>
                        </div>
                        
                        <div style="background-color: #90EE90; padding: 15px; margin-bottom: 10px; border-radius: 5px;">
                            <h3 style="color: #333; margin: 0;">Deployment Details</h3>
                            <p style="color: #333; margin: 5px 0;">
                                <strong>Status:</strong> ‚úÖ SUCCESS<br>
                                <strong>Application:</strong> AI Frontend<br>
                            
                            </p>
                        </div>
                        
                        <div style="background-color: #87CEEB; padding: 15px; margin-bottom: 10px; border-radius: 5px;">
                            <h3 style="color: white; margin: 0;">Environment</h3>
                            <p style="color: white; margin: 5px 0;">
                                <strong>Environment:</strong> Production<br>
                            
                                <strong>Triggered By:</strong> Automatic
                            </p>
                        </div>
                        
                        <hr style="border: none; border-top: 1px solid #ccc; margin: 20px 0;">
                        <p style="color: #666; font-size: 12px;">
                            This is an automated email from Jenkins CI/CD Pipeline
                        </p>
                    </body>
                    </html>
                """,
                to: 'geit.deepak@gmail.com',
                mimeType: 'text/html'
            )  // ‚Üê Don't forget closing parenthesis!
        }
    }
    
    failure {
        script {
            emailext(
                attachLog: true,
                from: 'geit.deepak@gmail.com',
                subject: "‚ùå AI Frontend Application Deployment FAILED",
                body: """
                    <html>
                    <body style="font-family: Arial, sans-serif;">
                        <h2 style="color: red;">‚ùå Deployment Failed</h2>
                        <p>Pipeline failed at: ${JOB_NAME} #${BUILD_NUMBER}</p>
                        <p><a href="${BUILD_URL}console">View Console Output</a></p>
                    </body>
                    </html>
                """,
                to: 'geit.deepak@gmail.com',
                mimeType: 'text/html'
            )
        }
    }
}

}
